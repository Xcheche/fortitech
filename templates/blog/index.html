{% extends 'base.html' %}
{% load static %}
{% load blog_extras %}



{% block content %}
<div class="container">
    <div class="pages_heder">
        <h2>Home</h2>
        <ol class="breadcrumb">
            <!-- <li><a href="/">Home</a></li>  -->
            <li><a href="{% url 'home' %}" class="active">Home</a></li>
        </ol>
    </div>
</div> 
<!-- End Pages Heder Area -->  

<section class="post_section news_post_2">
    <div class="container">
        <div class="row post_section_inner">
            <!-- Left_sidebar -->
            <div class="col-lg-8 left_sidebar"> 
                <!-- Feature Post Area-->
                <div class="row feature_post_area">
                    <div class="col-12">
                        <div class="feature_tittle"> 
                            <h2 style="text-align:left;">Latest Posts</h2>
                            <div class="post_select_button"> 
                                <select class="post_select" onchange="if(this.value) window.location.href=this.value;">
                                    <option value="">-- Select Category --</option>
                                    {% for category in categories_with_post_count %}
                                        <option value="{{ category.get_absolute_url }}"
                                            {% if category_selected and category_selected.id == category.id %}selected{% endif %}>
                                            {{ category.name }} ({{ category.post_count }})
                                        </option>
                                    {% endfor %}
                                </select>
                                
                            </div>
                        </div>
                    </div>

                    <!--=====================Wrapping the django blog loop with id search to match javascript==================== -->
                    <div id="results" class="col-12">
                        {% for post in posts %}
                        <div class="media feature_post" > 
                           <div class="feture_img"> 
                            <a href="{{ post.get_absolute_url }}">
                                {% if post.post_image and post.post_image.url %}
                                    <img src="{{ post.post_image.url }}" alt="{{ post.title }}">
                                {% else %}
                                    <img src="{% static 'images/post/placeholder.png' %}" alt="Placeholder Image">
                                {% endif %}
                            </a>
                                <ul class="special_share">
                                    <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                                    <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                    <li><a href="#"><i class="fa fa-google-plus"></i></a></li>
                                </ul>
                           </div> 
                            <div class="media-body feture_content">
                                <a href="{{ post.get_absolute_url }}" class="f_heding">{{ post.title }}</a>
                                <a href="{{ post.get_absolute_url }}#comments"><i class="fa fa-comment" style="color: #82459a;"></i>  <span style="color: #cd8148;">({{ post.comments.count }})</span></a>
                                <h6>{{ post.publish }} <span>|</span><a href="{% url 'user-posts' post.author.email %}">
                                    {{ post.author.email|nice_name }}</a></h6>
                                <p>{{ post.body|safe|truncatechars:50 }}</p>
                                 <span class="badge badge-secondary ml-2" id="like-count">Likes {{ post.total_likes }} | Views {{ post.views }}</span>

                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <!--=========================== End of wrapping the django blog loop with id search to match javascript====================== -->
                    <!-- <div class="col-12">
                        <div class="media feature_post"> 
                           <div class="feture_img"> 
                                <a href="news-details.html"><img src="{% static 'images/post/travel-post-2.jpg' %}" alt=""></a>  
                                <ul class="special_share">
                                    <li><a href="#"><i class="fa fa-twitter"></i></a></li>
                                    <li><a href="#"><i class="fa fa-facebook"></i></a></li>
                                    <li><a href="#"><i class="fa fa-google-plus"></i></a></li>
                                </ul>
                           </div> 
                            <div class="media-body feture_content">
                                <a href="news-details.html" class="f_heding">Bitcoin ETFs seek approval of skeptical <br> regulator</a>
                                <h6>Jan 10, 2018 at 19:35 <span>|</span><a href="http://emran-khan.com/">Emran Khan</a></h6>
                                <p>It is a long established fact that a reader will be distracted by the readable content of a page when looking at its layout</p>
                            </div>
                        </div>
                    </div> -->
                   
                  
                    <div class="col-12">
                       
                        {% if posts.has_next %}
                        <a href="#"
                        id="load-more-btn"
                        class="load_more_btn"
                        data-next-page="{{ posts.next_page_number }}"
                        {% if category_selected %}data-category="{{ category_selected.id }}"{% endif %}>
                        Load more..
                     </a>
                    {% endif %}
                    
                 
                    </div>
                </div> 
            </div>
            <!--==== End left_sidebar ==== -->

            <!--====Search====-->
            <div class="col-lg-4 right_sidebar"> 
                <!-- id= search-form  for javascript and id=search-input for javascript -->
                <form action="{% url 'post_search' %}" method="get" class="input-group mb-3"   id="search-form">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" value="{{ query }}" placeholder="Search" id="search-input">
                        <div class="input-group-append">
                            <button class="input-group-text" type="submit">
                                <i class="fa fa-search"></i>
                            </button>
                        </div>
                    </div>
                </form>
                <!--==End search==-->

                <!-- Loading overlay -->
                <div id="loading-overlay" style="
                                  display:none;
                                  position:fixed;
                                  top:0;left:0;right:0;bottom:0;
                                  background:rgba(0,0,0,0.3);
                                  z-index:9999;
                                  justify-content:center;
                                  align-items:center;
                                ">
                    <div class="spinner-border text-light" role="status"></div>
                </div>

                <!--==Categories==-->
                <div class="categories">
                    <h3>Post Categories</h3>
                    <ul class="cpost_categories">
                        {% for category in categories_with_post_count %}
                            <li>
                                <a href="{{ category.get_absolute_url }}"
                                   {% if category_selected and category_selected.id == category.id %}class="active"{% endif %}>
                                    {{ category.name }}
                                    <span>{{ category.post_count }}</span>
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </div> 
                <!--==End Categories==-->

               {% include 'blog/popular.html' %}
              
                
                <!-- Video widget -->
                {% include 'blog/news.html' %}
                
                
            </div>
        </div>
    </div>
</section>

<!--=========================== AJAX Load More Posts============================= -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const postList = document.getElementById('post-list');
        const loadMoreBtn = document.getElementById('load-more-btn');
    
        if (loadMoreBtn) {
            loadMoreBtn.addEventListener('click', function(event) {
                event.preventDefault(); // stop link from refreshing the page
    
                const nextPage = this.dataset.nextPage;
                const categoryId = this.dataset.category || ''; // optional category filter
    
                let url = `?page=${nextPage}`;
                if (categoryId) {
                    url = `?category=${categoryId}&page=${nextPage}`;
                }
    
                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
    
                        // Append only post items
                        const newPosts = doc.querySelectorAll('#post-list .media.feature_post');
                        newPosts.forEach(post => postList.appendChild(post));
    
                        // Update button or remove it if no more pages
                        const newBtn = doc.querySelector('#load-more-btn');
                        if (newBtn) {
                            loadMoreBtn.dataset.nextPage = newBtn.dataset.nextPage;
                        } else {
                            loadMoreBtn.remove();
                        }
                    });
            });
        }
    });
    </script>
<!--=========================== End of AJAX Load More Posts============================= -->

<!--=========================== AJAX Search============================= -->
<script>
    document.getElementById("search-input").addEventListener("input", function () {
        const form = document.getElementById("search-form");
        const query = this.value;

        fetch(form.action + "?q=" + encodeURIComponent(query))
            .then(res => res.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, "text/html");
                const newResults = doc.querySelector("#results").innerHTML;
                document.getElementById("results").innerHTML = newResults;
            });
    });
</script>
<!--=========================== End of AJAX Search============================= -->



<!--=========================== Loading overlay============================= -->

<style>
    /* Loading overlay */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
    }
</style>

<div id="loading-overlay">
    <div>Loading...</div>
</div>

<script>
    // Dim and show loading screen when form is submitted
    document.addEventListener("DOMContentLoaded", function () {
        const forms = document.querySelectorAll("form");
        const overlay = document.getElementById("loading-overlay");
        forms.forEach(form => {
            form.addEventListener("submit", function () {
                overlay.style.display = "flex";
            });
        });
    });
</script>
    
<!--=========================== End of Loading overlay============================= -->


















    
{% endblock %}